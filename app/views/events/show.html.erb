<h1 style="text-align: center;"><%= @event.title %></h1>

<div style="text-align: center">
  <strong>説明：</strong><br>
  <%= simple_format(@event.description) %>
</div>

<p style="text-align: center"><strong>場所：</strong><%= @event.location %></p>
<p style="text-align: center"><strong>開始：</strong><%= @event.start_datetime.strftime("%Y-%m-%d %H:%M") %></p>
<p style="text-align: center"><strong>終了：</strong><%= @event.end_datetime.strftime("%Y-%m-%d %H:%M") %></p>
<p style="text-align: center"><strong>定員：</strong><%= @event.capacity %> 名</p>
<p style="text-align: center"><strong>カテゴリ：</strong><%= @event.category %></p>
<p style="text-align: center"><strong>主催者：</strong><%= @event.organizer %></p>

<% if @event.thumbnail_url.present? %>
  <p style="text-align: center">
    <img src="<%= @event.thumbnail_url %>" width="300">
  </p>
<% end %>

<hr>

<% if logged_in? %>
  <%# 現在の参加者数（favorite と confirmed を参加としてカウント） %>
  <% total_participants = @event.participations.where(status: ["favorite", "confirmed"]).count %>

  <% if @participation.nil? %>
    <% if total_participants < @event.capacity %>
      <!-- まだ参加していない & 定員に空きあり -->
      <div style="text-align: center">
        <%= button_to "参加希望を送る", participations_path(event_id: @event.id), method: :post %>
      </div>
    <% else %>
      <!-- まだ参加していない & 定員いっぱい -->
      <p style="text-align: center; color: red;"><strong>定員に達しました</strong></p>
    <% end %>

  <% elsif @participation.status.in?(["favorite", "confirmed"]) %>
    <!-- 参加済み -->
    <p style="text-align: center">
      <strong>ステータス：</strong>
      <%= @participation.status == "favorite" ? "参加希望" : "確定" %>
    </p>
    <div style="text-align: center">
      <%= button_to "キャンセル", participation_path(@participation), method: :delete, data: { turbo_confirm: "本当にキャンセルしますか？" } %>
    </div>

  <% elsif @participation.status == "canceled" %>
    <!-- キャンセル済み -->
    <p style="text-align: center; color: gray;"><strong>ステータス：</strong>キャンセル済み</p>
    <div style="text-align: center">
      <%= button_to "再登録（参加希望）", participation_path(@participation, status: "favorite"), method: :patch %>
    </div>
  <% end %>
<% end %>

<hr>

<% if logged_in? && (@event.creator_id == current_user.id || current_user.admin?) %>
  <p style="text-align: center">
    <%= link_to "編集", edit_event_path(@event) %> |
    <%= link_to "削除", event_path(@event), data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" } %>
  </p>

  <hr>
  <h2>参加希望者一覧（<%= @favorite_count %> 人）</h2>

  <% if @participations.any? %>
    <table border="1" cellpadding="6">
      <tr>
        <th>#</th>
        <th>名前</th>
        <th>Email</th>
        <th>登録日時</th>
      </tr>
      <% @participations.each_with_index do |p, i| %>
        <tr>
          <td><%= i + 1 %></td>
          <td><%= p.user.name %></td>
          <td><%= p.user.email %></td>
          <td><%= p.created_at.strftime("%Y-%m-%d %H:%M") %></td>
        </tr>
      <% end %>
    </table>
  <% else %>
    <p>現在、参加希望者はいません。</p>
  <% end %>
<% end %>

<hr>

<p style="text-align: center">
  <%= link_to "一覧に戻る", events_path %>
</p>

<p style="text-align: center; margin-top: 24px;">
  <%= link_to "＋ 新しいイベントを作成", new_event_path, class: "new-event-link" %>
</p>
